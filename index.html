<!DOCTYPE html>
<html>
<head>
    <title>Uhh Yeah Notes</title>
</head>
<body>

<h2><a href="/">Notes</a></h2>

<input autocomplete="off" type="search" id="search" placeholder="search title or notes"/>

<div id="table"></div>

<script>
// get data
var rawFile = new XMLHttpRequest();
rawFile.open("GET", "data.json", false);
rawFile.send(null);

var allText = rawFile.responseText;
var parsed = JSON.parse(allText);
parsed.sort(function(a, b) {return b.Episode - a.Episode});

// set up table html
var tableHeader = "<table><tr><th>Episode</th><th>Date</th><th>Title/Note</th></tr>";
var tableContent = "";
var tableFooter = "</table>";

// check for url
const queryString = window.location.search;
const urlParams = new URLSearchParams(queryString);
const url_search = urlParams.get('q')

// search
const search = document.getElementById("search");
let search_term = "";

if (url_search != null)
{
  search_term = url_search;
  search.value = search_term;
}


const showList = () => {
  document.innerHTML = "";
  tableContent = "";
  re = new RegExp(search_term, 'g');
  if (search_term != "")
  {
    parsed
      .filter((item) => {
        return (
          item.Title.toLowerCase().includes(search_term) ||
          item.Note.toLowerCase().includes(search_term)
        );
      })
      .forEach((e) => {
          // Loop through the JSON and output each row in to a string.
              tableContent = tableContent + "<tr><td>" + e.Episode 
                                          + "</td><td>" + e.Date 
                                          + "</td><td><b>" + highlight(e.Title, search_term)
                                          + "</b><br>" + highlight(e.Note, search_term)
                                          + "<br><br></td></tr>";
      });
  }
  else 
  {
    parsed
      .forEach((e) => {
          // Loop through the JSON and output each row in to a string.
              tableContent = tableContent + "<tr><td>" + e.Episode 
                                          + "</td><td>" + e.Date 
                                          + "</td><td><b>" + e.Title
                                          + "</b><br>" + e.Note
                                          + "<br><br></td></tr>";
    });
  }
    document.getElementById("table").innerHTML = tableHeader + tableContent + tableFooter;
};

showList();

search.addEventListener("input", (event) => {
  search_term = event.target.value.toLowerCase();
  urlParams.set('q', search_term);
  history.pushState(null, null, "?"+urlParams.toString());
  if (search_term == null || search_term == "")
  {
    history.pushState(null, null, "/");
  }
  showList();
});

function highlight(str, find) {
  var reg = new RegExp(find, 'gi');
  return str.replace(reg, '<mark>$&</mark>');
}

</script>
</body>

</html>

